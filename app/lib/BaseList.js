define("BaseList",["jquery","underscore","backbone","BaseUtils","HandlebarsHelper"],function(t,i,e){var o,n,s,l;n=t("backbone"),s=t("BaseUtils"),l=t("HandlebarsHelper"),o=n.View.extend({constructor:function(t){this.options=t||{},n.View.apply(this,arguments)},_initialize:function(t){return this._initCollection(t.collection,t)},_initCollection:function(t,i){debug("1.BaseList._initialize"),this._options=i||{};var e=this;this.dx=0;var o=Est.promise;return this.views=[],this.$el.empty(),this._options.template&&(this._options.data=this.options.data||this._options.data||{},this.template=l.compile(this._options.template),this.$el.html(this.template(this._options.data))),this._data=this._options.data,this._options.max=this.options.max||99999,this._options.enterRender&&this._enterEvent(),this.list=this._options.render?$(this._options.render):this.$el,this.list&&0!==this.list.size()||debug("当前"+this.options.viewId+"视图无法找到选择符， 检查XxxList中的_initialize方法中是否定义render或 实例化对象(new XxxList({...}))中是否存入el; 或检查html文档是否正确？当前render或el选择符为"+(this._options.render?this._options.render:this.el),{type:"error"}),this.allCheckbox=this.$("#toggle-all")[0],this._options.sortField="sort",this._options.model||debug('BaseList中initialize参数中未添加模型类， 检查config.js是否addModule("model"), 或头部是否引入'),this.collection||(this.collection=new t(this._options)),this.options.itemId&&this.collection._setItemId(this.options.itemId),this._options.subRender&&(this.composite=!0),this._initItemView(this._options.item,this),this._initModel(this._options.model),this._initBind(),this.options.items&&("function"===Est.typeOf(this.options.items)&&(this.options.items=this.options.items.apply(this,arguments)),Est.each(this.options.items,function(t){this.collection.push(new e.initModel(t))},this)),new o(function(t){t(e)})},_render:function(){debug("BaseList._render"),this._addAll(),this.trigger("after",this)},_filterRoot:function(){var t=this,i=[];t.composite=!1,Est.each(t.collection.models,function(e){i.push({categoryId:e.attributes[t._options.categoryId],belongId:e.attributes[t._options.parentId]})}),this.collection.each(function(e){for(var o=i.length,n=[];o>0;){var s=i[o-1];s.belongId===e.get(t._options.categoryId)&&(n.unshift(s.categoryId),i.splice(o,1)),o--}e.set("children",n),("01"===e.get("isroot")||!e.get("isroot")&&"/"===e.get("parentId")||!e.get("isroot")&&Est.isEmpty(e.get("parentId")))&&(e.set("level",1),t._addOne(e))}),debug(t.collection)},_addOne:function(t){var i=this;if(!this.filter&&!this.composite&&this.dx<this._options.max){t.set("dx",this.dx++),t.set("_options",{_item:i._options.item,_collection:Est.isEmpty(i._options.subRender)?null:i.collection,_subRender:i._options.subRender,_collapse:i._options.collapse,_extend:i._options.extend,_checkAppend:i._options.checkAppend,_data:i.options.data||i._options.data});var e=new this.item({model:t,data:this._data});e._setInitModel(this.initModel),this._options.viewId&&e._setViewId(this._options.viewId),this.list.append(e._render().el),this.views.push(e)}},_initPagination:function(t){var i=this;i.collection&&i.collection.paginationModel&&i.collection.paginationModel.on("reloadList",function(e){i._load.call(i,t,e)})},_load:function(t,i){var e=this,o=Est.promise;return t=t||{},new o(function(o){t.beforeLoad&&t.beforeLoad.call(e,e.collection),t.page&&e.collection.paginationModel.set("page",t.page),t.pageSize&&e.collection.paginationModel.set("pageSize",t.pageSize),(t.page||t.pageSize)&&(i=e.collection.paginationModel),e.collection.url&&(e._options.filter&&(e.filter=!0),e._options.subRender&&(e.composite=!0),e.collection._load(e.collection,e,i).then(function(t){e.options.instance&&app.setData(e.options.instance,t.models),0===t.length&&console.log("从服务器上传回来的列表为空！"),e._options.subRender&&e._filterRoot(),e._options.filter&&e._filter(e._options.filter,e._options),o(t)}))})},_initBind:function(){this.collection&&(this.collection.bind("add",this._addOne,this),this.collection.bind("reset",this._render,this))},_enterEvent:function(){var t=this;this._options.enterRender&&this.$("input").keyup(function(i){i.keyCode===CONST.ENTER_KEY&&t.$(t._options.enterRender).click()})},_initItemView:function(t){this.item=t},_initModel:function(t){this.initModel=t},_empty:function(){if(this.dx=0,debug("5.BaseList._empty"),this.collection)for(var t=this.collection.length;t>-1;)this.collection.remove(this.collection[t]),t--;this.collection.paginationModel&&(this.dx=this.collection.paginationModel.get("pageSize")*(this.collection.paginationModel.get("page")-1)),Est.each(this.views,function(t){t.off().remove()}),this.views=[]},_addAll:function(){debug("BaseList._addAll and call this._empty"),this._empty(),this.collection.each(this._addOne,this)},_search:function(t){var i=this;this.filter=!0,t=Est.extend({onBeforeAdd:function(){}},t),this._load({page:1,pageSize:5e3}).then(function(){i.filter=!1,i._filter(t.filter||i._options.filter,t)})},_filter:function(t,i){var e=this,o=[],n=e.collection.models.length;for(e.filter=!1;n>0;){var s=e.collection.models[n-1],l=!0;Est.each(t,function(t){var i=Est.getValue(s.attributes,t.key);return!l||Est.isEmpty(t.value)||i&&-1!==i.indexOf(t.value)?void 0:(e.collection.remove(s),l=!1,!1)}),l&&i.onBeforeAdd&&i.onBeforeAdd.call(this,s),l&&o.unshift(s),n--}Est.each(o,function(t){e._addOne(t)})},_detail:function(t){debug("1.BaseList._detail"),t=t||{},t.end=t.end?"?"+t.end+"&":"";var i=this;seajs.use(["dialog-plus"],function(e){window.dialog=e;var o=[];t.hideSaveBtn||o.push({value:"保存",callback:function(){return this.title("正在提交.."),this.iframeNode.contentWindow.$("#submit").click(),!1},autofocus:!0}),t.hideResetBtn||o.push({value:"重置",callback:function(){return this.iframeNode.contentWindow.$("#reset").click(),!1}}),o.push({value:"关闭"}),debug("您请求的详细页网址是："+(t.url||i._options.detail+t.end)+"页面不显示？ 点击链接是否访问正常？检查XxxList中的_initialize配置是否设置detail参数？"),window.detailDialog=e({id:"detail-dialog",title:t.title||"添加",height:t.height||"auto",width:t.width||850,padding:t.padding||0,url:t.url||i._options.detail+t.end,button:o,oniframeload:function(){this.iframeNode.contentWindow.detailDialog=window.detailDialog,this.iframeNode.contentWindow.app=app,t.oniframeload&&t.oniframeload.call(this,this.iframeNode.contentWindow)},onclose:function(){i._options.subRender&&(i.composite=!0),i.collection._load(i.collection,i).then(function(){i._options.subRender&&(i.composite=!0,i._filterRoot())}),this.remove(),this.returnValue&&$("#value").html(this.returnValue)}}),window.detailDialog.showModal()})},_toggleAllChecked:function(){var t=this.allCheckbox.checked;this.collection.each(function(i){i.set("checked",t)})},_saveSort:function(t){var i={id:t.get("id")};i[this._options.sortField||"sort"]=t.get(this._options.sortField),t._saveField(i,this,{async:!1,hideTip:!0})},_exchangeOrder:function(t,i,e){var o={},n={},s=this.collection.at(t),l=this.collection.at(i),c=s.view.model.get("dx"),a=l.view.model.get("dx");if(o.dx=a,n.dx=c,e.path){var d=s.view.model.get(e.path),h=l.view.model.get(e.path);o[e.path]=h,n[e.path]=d}return s.view.model.set(o),l.view.model.set(n),this.collection.models[i]=this.collection.models.splice(t,1,this.collection.models[i])[0],i>t?s.view.$el.before(l.view.$el):s.view.$el.after(l.view.$el),e.success&&e.success.call(this,s,l),this},_moveUp:function(t){debug("_moveUp");var i,e,o=this.collection.indexOf(t),n=[];if(this._options.subRender){e=t.get("belongId"),this.collection.each(function(t){e===t.get("belongId")&&n.push(t)});var s=Est.findIndex(n,function(i){return i.get("id")===t.get("id")});if(0===s)return;i=this.collection.indexOf(n[s-1])}else{if(0===o)return;i=o-1}t.stopCollapse=!0,this._exchangeOrder(o,i,{path:this.sortField||"sort",success:function(i,e){i.get("id")&&e.get("id")&&(this._saveSort(i),this._saveSort(e),t.stopCollapse=!1)}})},_moveDown:function(t){debug("_moveDown");var i,e,o=this.collection.indexOf(t),n=[];if(this._options.subRender){e=t.get("belongId"),this.collection.each(function(t){e===t.get("belongId")&&n.push(t)});var s=Est.findIndex(n,function(i){return i.get("id")===t.get("id")});if(s===n.length-1)return;i=this.collection.indexOf(n[s+1])}else{if(o===this.collection.models.length-1)return;i=o+1}t.stopCollapse=!0,this._exchangeOrder(o,i,{path:this._options.sortField,success:function(i,e){i.get("id")&&e.get("id")&&(this._saveSort(i),this._saveSort(e),t.stopCollapse=!1)}})},_getCheckboxIds:function(){var t=Est.pluck(Est.filter(this.collection.models,function(t){return t.attributes.checked}),"id");return 0===t.length?void s.tip("至少选择一项"):t},_batch:function(t){var i=this;t=Est.extend({tip:"操作成功！"},t),(this.checkboxIds=this._getCheckboxIds())&&$.ajax({type:"POST",async:!1,url:t.url,data:{ids:i.checkboxIds.join(",")},success:function(){s.tip(t.tip),i._load()}})},_batchDel:function(){var t=this;s.comfirm({success:function(){t._batch({url:t.collection.batchDel,tip:"删除成功"})}})},_setOption:function(t){return Est.extend(this._options,t),this}}),e.exports=o});