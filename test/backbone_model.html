<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <title>Document</title>
    <link rel="stylesheet" href="styles/todos.css"/>
</head>
<body>
<div>event test</div>
<script type="text/javascript" src="../scripts/base.js"></script>
<script type="text/javascript">
    (function () {

        var Book = Backbone.Model.extend({
            defaults: {
                name: 'unknow',
                author: 'unknow',
                price: 0
            },
            validate: function(data){
                if (data.price < 1){
                    return "书籍价格不应该低于1元";
                }
            }
        });

        var javabook = new Book();

        javabook.on("change", function(model){
            console.log("change事件被触发");
            console.log(model);
        });


        javabook.on("change:name", function(model, value){
            var newValue = value; // 获取修改后的数据
            var oldValue = model.previous("name"); // 获取修改前的数据
            var oldObject = model.previousAttributes(); // 获取修改前的对象

            console.log("newValue", newValue);
            console.log("oldValue", oldValue);
            console.log("oldObject", oldObject);
            console.log("change:name事件被触发");
            console.log(model);
            console.log(value);
        });

        // 监听validate验证
        javabook.on("error", function(model, error){
            alert(error);
        });
        // 验证不通过时执行
        javabook.on("invalid", function(model, error) {
            alert(model.get("name") + " " + error);
        });

        javabook.set({
            name: "Thinking in java",
            author: "unknow",
            price: 0
        }, {
            validate: true
        });

        // 自定义的error处理方法
        javabook.set("price", 0, {
            error: function(model, error){
                console.log("自定义错误：" + error);
            }
        });

        // 忽略验证规则 , 只忽略本次的数据验证， 如果再set的话， 就会失效
        javabook.set("price", 0, {
            silent: true
        });

        // 我们设置一个非法数据并绕过验证
        javabook.set('price', 0.2, {
            silent : true
        });

        // 检查数据非法，回滚数据
        if(javabook.get('price') < 1) {
            var value = javabook.previous('price');
            javabook.set('price', value);
        }

        // 删除对象name属性
        javabook.unset("name");
        // 删除整个对象的所有属性
        javabook.clear();



        // 将数据保存到服务器
        javabook.save(null, {
            success : function(model) {
                // 数据保存成功之后, 修改price属性并重新保存
                javabook.set({
                    price : 388.00
                });
                javabook.save();
            }
        });
        // 从将数据保存到服务器  若请求服务器出错  则数据会回滚
        javabook.save({
            name : 'Thinking in Java',
            author : 'Bruce Eckel',
            price : 395.70
        }, {
            wait : true
        });

        // 从将数据保存到服务器
        javabook.save({
            name : 'Thinking in Java',
            author : 'Bruce Eckel',
            price : 395.70
        });
        // 保存其中的某一个值
        javabook.save('name', 'Thinking in Java');

        var Book = Backbone.Model.extend({
            urlRoot : '/service',
            // 重载parse方法解析服务器返回的数据
            parse : function(resp, xhr) {
                var data = resp.data[0];
                return {
                    id : data.bookId,
                    name : data.bookName,
                    author : data.bookAuthor,
                    price : data.bookPrice
                }
            }
        });


    }).call(this);
</script>
</body>
</html>


